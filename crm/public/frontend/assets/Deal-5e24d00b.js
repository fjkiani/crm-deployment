import{f as qe}from"./DeleteLinkedDocModal-c2177d5b.js";import{_ as Fe}from"./ErrorPage-a584eafb.js";import{_ as je}from"./Icon-45f73f91.js";import{_ as We}from"./Resizer-80c7f14e.js";import{A as Ge,a as de,u as He,_ as Xe,b as Ye,c as Je,S as Ke,L as Qe}from"./useActiveTabManager-fa0d94aa.js";import{E as Ze}from"./Popover-8dca6077.js";import{E as me}from"./Email2Icon-c1b9e420.js";import{C as ea}from"./CommentIcon-e9c2d913.js";import{D as aa}from"./DetailsIcon-9525593a.js";import{P as Y}from"./PhoneIcon-163d6efc.js";import{T as ta}from"./TaskIcon-281a54c1.js";import{N as oa}from"./NoteModal-a164d0cf.js";import{W as sa}from"./WhatsAppIcon-2bf84a6f.js";import{I as la}from"./IndicatorIcon-d4bc6b51.js";import{L as na}from"./LinkIcon-a59b507b.js";import{A as ra}from"./ArrowUpRightIcon-7aa30d20.js";import{g as ia,S as ca,a as ua}from"./view-afc32c53.js";import{L as da}from"./LayoutHeader-cf0d6bfd.js";import{_ as ma}from"./OrganizationModal-4b796649.js";import{_ as pa}from"./LostReasonModal-7c587ca8.js";import{C as fa}from"./ContactModal-74761337.js";import{_ as _a}from"./Link-20d88da1.js";import{u as pe,_ as va,b as ga}from"./modals-46bf454d.js";import{_ as fe}from"./CustomActions-850c41b3.js";import{a as ya,s as ba,D as _e,d as ha,o as Ca}from"./index-51111d39.js";import{g as ka}from"./settings-356f0a94.js";import{g as wa}from"./global-b60b0ad1.js";import{s as xa}from"./statuses-1e3dbc3d.js";import{w as Ia,c as Da}from"./DragVerticalIcon-8d10794b.js";import{$ as Va,a7 as Aa,l as g,y as D,z as J,a as Sa,a4 as y,o as Ma,X as ve,c as h,b as l,a8 as $a,w as d,u as o,a9 as ge,g as f,B as u,F as ye,a3 as L,e as be,f as n,n as K,d as m,t as x,Y as he,r as za,a6 as Ce,a2 as Ra,G as Ta}from"./index-ecb7d9f9.js";import{a as ke}from"./UserAvatar-3b1cafda.js";import{_ as Ea}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-772d6a19.js";import{u as Oa}from"./pageMeta-87160cdf.js";import{u as La}from"./helpCenter-98c03024.js";import"./CalendarIcon-d6b50db0.js";import"./CallLogModal-b7105153.js";import"./ContactsIcon-c13cd4cc.js";import"./LeadsIcon-941ca533.js";import"./DealsIcon-a7b4eb56.js";import"./TaskModal-8bcc6823.js";import"./FadedScrollableDiv-6645747f.js";import"./FieldLayout-e4d12c4e.js";import"./MultipleAvatar-ca0c28ec.js";import"./IconPicker-fb047545.js";import"./FileUploader-2c52ffd6.js";import"./Switch.vue_vue_type_script_setup_true_lang-fa514def.js";import"./label-643deaf1.js";const Ba={key:0,class:"flex h-full overflow-hidden"},Na={class:"flex items-center justify-start gap-5 border-b p-5"},Ua={class:"group relative size-12"},Pa={class:"flex flex-col gap-2.5 truncate text-ink-gray-9"},qa={class:"truncate text-2xl font-medium"},Fa={class:"flex gap-1.5"},ja={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Wa={key:0,class:"pr-2"},Ga={key:0,class:"contacts-area"},Ha={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-ink-gray-4"},Xa={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-ink-gray-7"},Ya=["onClick"],Ja={class:"truncate"},Ka={class:"flex items-center"},Qa={class:"flex flex-col gap-1.5 text-base text-ink-gray-8"},Za={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},et={class:"flex items-center gap-3 p-1 py-1.5"},at={key:0,class:"mx-2 h-px border-t border-outline-gray-modals"},tt={key:2,class:"flex h-20 items-center justify-center text-base text-ink-gray-5"},Jt={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(C){const{brand:we}=ka(),{$dialog:xe,$socket:B,makeCall:Ie}=wa(),{statusOptions:De,getDealStatus:N}=xa(),{doctypeMeta:Ve}=ya("CRM Deal"),{updateOnboardingStep:Ae,isOnboardingStepsCompleted:Se}=La("frappecrm"),I=Va(),U=Aa(),k=C,V=g(""),P=g(""),M=g(!1),{triggerOnChange:Me,assignees:q,document:r,scripts:Q,error:$e}=pe("CRM Deal",k.dealId),c=D(()=>r.doc||{});J($e,e=>{var a;e?(V.value=__(e.exc_type=="DoesNotExistError"?"Document not found":"Error occurred"),P.value=__(((a=e.messages)==null?void 0:a[0])||"An error occurred")):(V.value="",P.value="")}),J(()=>r.doc,async e=>{var a;if((a=Q.data)!=null&&a.length){let s=await ba(Q.data,{doc:e,$dialog:xe,$socket:B,router:U,toast:y,updateField:H,createToast:y.create,deleteDoc:te,call:L});r._actions=s.actions||[],r._statuses=s.statuses||[]}},{once:!0});const F=g(null);J(()=>c.value.organization,e=>{var a;if(e&&!((a=F.value)!=null&&a.doc)){let{document:s}=pe("CRM Organization",e);F.value=s}},{immediate:!0});const Z=D(()=>{var e;return((e=F.value)==null?void 0:e.doc)||{}});Sa(()=>{B.on("crm_customer_created",()=>{y.success(__("Customer created successfully"))})}),Ma(()=>{B.off("crm_customer_created")});const j=g(!1),$=g(!1),W=g(!1),ee=g({}),ze=D(()=>{let e=[{label:__("Deals"),route:{name:"Deals"}}];if(I.query.view||I.query.viewType){let a=ia(I.query.view,I.query.viewType,"CRM Deal");a&&e.push({label:__(a.label),icon:a.icon,route:{name:"Deals",params:{viewType:I.query.viewType},query:{view:I.query.view}}})}return e.push({label:z.value,route:{name:"Deal",params:{dealId:k.dealId}}}),e}),z=D(()=>{var a,s;let e=((a=Ve["CRM Deal"])==null?void 0:a.title_field)||"name";return((s=c.value)==null?void 0:s[e])||k.dealId}),Re=D(()=>{var a;let e=(a=r.statuses)!=null&&a.length?r.statuses:r._statuses||[];return De("deal",e,Ne)});Oa(()=>({title:z.value,icon:we.favicon}));const R=D(()=>[{name:"Activity",label:__("Activity"),icon:Ge},{name:"Emails",label:__("Emails"),icon:Ze},{name:"Comments",label:__("Comments"),icon:ea},{name:"Data",label:__("Data"),icon:aa},{name:"Calls",label:__("Calls"),icon:Y},{name:"Tasks",label:__("Tasks"),icon:ta},{name:"Notes",label:__("Notes"),icon:oa},{name:"Attachments",label:__("Attachments"),icon:de},{name:"WhatsApp",label:__("WhatsApp"),icon:sa,condition:()=>Ia.value}].filter(a=>a.condition?a.condition():!0)),{tabIndex:w}=He(R,"lastDealTab"),A=ve({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Deal"],params:{doctype:"CRM Deal"},transform:e=>Te(e)});A.data||A.fetch();function Te(e){return e.forEach(a=>{a.name!="contacts_section"&&a.columns[0].fields.forEach(s=>{s.fieldname=="organization"&&(s.create=(p,t)=>{ee.value.organization_name=p,$.value=!0,t()},s.link=p=>U.push({name:"Organization",params:{organizationId:p}}))})}),e}const T=g(!1),ae=g({});function Ee(e){let a=[{label:__("Remove"),icon:"trash-2",onClick:()=>Oe(e.name)}];return e.is_primary||a.push({label:__("Set as Primary Contact"),icon:Ra(ua,{class:"h-4 w-4"}),onClick:()=>Le(e.name)}),a}async function G(e){var s;if((s=_.data)!=null&&s.find(p=>p.name===e)){y.error(__("Contact already added"));return}await L("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:k.dealId,contact:e})&&(_.reload(),y.success(__("Contact added")))}async function Oe(e){await L("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:k.dealId,contact:e})&&(_.reload(),y.success(__("Contact removed")))}async function Le(e){await L("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:k.dealId,contact:e})&&(_.reload(),y.success(__("Primary contact set")))}const _=ve({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:k.dealId},cache:["deal_contacts",k.dealId],transform:e=>(e.forEach(a=>{a.opened=!1}),e)});_.data||_.fetch();function Be(){var s;let e=(s=_.data)==null?void 0:s.find(p=>p.is_primary),a=e.mobile_no||null;if(!e){y.error(__("No primary contact set"));return}if(!a){y.error(__("No mobile number set"));return}Ie(a)}async function Ne(e){await Me("status",e),oe()}function H(e,a){e=="status"&&!Se.value&&Ae("change_deal_status"),a=Array.isArray(e)?"":a;let s=Array.isArray(e)?{}:c.value[e];Array.isArray(e)?e.forEach(p=>c.value[p]=a):c.value[e]=a,r.save.submit(null,{onSuccess:()=>j.value=!0,onError:p=>{var t;Array.isArray(e)?e.forEach(i=>c.value[i]=s[i]):c.value[e]=s,y.error(((t=p.messages)==null?void 0:t[0])||__("Error updating field"))}})}function te(){M.value=!0}const E=g(null);function Ue(){let e=R.value[w.value];["Emails","Comments","Activities"].includes(e.name)||E.value.changeTabTo("emails"),Ta(()=>E.value.emailBox.show=!0)}const O=g(!1);function oe(){if(N(r.doc.status).type!=="Lost"||r.doc.lost_reason&&r.doc.lost_reason!=="Other"||r.doc.lost_reason==="Other"&&r.doc.lost_notes){r.save.submit();return}O.value=!0}function se(e){e!=null&&e.hasOwnProperty("status")&&N(e.status).type=="Lost"?oe():r.save.submit(null,{onSuccess:()=>X(e)})}function X(e){e!=null&&e.hasOwnProperty("deal_owner")&&q.reload()}return(e,a)=>{const s=be("Button"),p=be("Badge");return n(),h(ye,null,[l(da,null,$a({"left-header":d(()=>[l(o(Ea),{items:ze.value},{prefix:d(({item:t})=>[t.icon?(n(),f(je,{key:0,icon:t.icon,class:"mr-2 h-4"},null,8,["icon"])):u("",!0)]),_:1},8,["items"])]),_:2},[V.value?void 0:{name:"right-header",fn:d(()=>{var t,i;return[(t=o(r)._actions)!=null&&t.length?(n(),f(fe,{key:0,actions:o(r)._actions},null,8,["actions"])):u("",!0),(i=o(r).actions)!=null&&i.length?(n(),f(fe,{key:1,actions:o(r).actions},null,8,["actions"])):u("",!0),l(Ye,{modelValue:o(q).data,"onUpdate:modelValue":a[0]||(a[0]=v=>o(q).data=v),doctype:"CRM Deal",docname:C.dealId},null,8,["modelValue","docname"]),c.value&&o(r).statuses?(n(),f(o(_e),{key:2,options:Re.value,placement:"right"},{default:d(({open:v})=>[c.value.status?(n(),f(s,{key:0,label:c.value.status,iconRight:v?"chevron-up":"chevron-down"},{prefix:d(()=>[l(la,{class:K(o(N)(c.value.status).color)},null,8,["class"])]),_:2},1032,["label","iconRight"])):u("",!0)]),_:1},8,["options"])):u("",!0)]}),key:"0"}]),1024),c.value.name?(n(),h("div",Ba,[l(o(va),{as:"div",modelValue:o(w),"onUpdate:modelValue":a[3]||(a[3]=t=>ge(w)?w.value=t:null),tabs:R.value},{"tab-panel":d(()=>[l(Je,{ref_key:"activities",ref:E,doctype:"CRM Deal",docname:C.dealId,tabs:R.value,reload:j.value,"onUpdate:reload":a[1]||(a[1]=t=>j.value=t),tabIndex:o(w),"onUpdate:tabIndex":a[2]||(a[2]=t=>ge(w)?w.value=t:null),onBeforeSave:se,onAfterSave:X},null,8,["docname","tabs","reload","tabIndex"])]),_:1},8,["modelValue","tabs"]),l(We,{side:"right",class:"flex flex-col justify-between border-l"},{default:d(()=>{var t;return[m("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium text-ink-gray-9",onClick:a[4]||(a[4]=i=>o(ha)(C.dealId))},x(e.__(C.dealId)),1),m("div",Na,[l(o(he),{text:e.__("Organization logo")},{default:d(()=>{var i;return[m("div",Ua,[l(o(ke),{size:"3xl",class:"size-12",label:z.value,image:(i=Z.value)==null?void 0:i.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),m("div",Pa,[l(o(he),{text:((t=Z.value)==null?void 0:t.name)||e.__("Set an organization")},{default:d(()=>[m("div",qa,x(z.value),1)]),_:1},8,["text"]),m("div",Fa,[o(Da)?(n(),f(s,{key:0,tooltip:e.__("Make a call"),icon:Y,onClick:Be},null,8,["tooltip"])):u("",!0),l(s,{tooltip:e.__("Send an email"),icon:me,onClick:a[5]||(a[5]=i=>c.value.email?Ue():o(y).error(e.__("No email set")))},null,8,["tooltip"]),l(s,{tooltip:e.__("Go to website"),icon:na,onClick:a[6]||(a[6]=i=>c.value.website?o(Ca)(c.value.website):o(y).error(e.__("No website set")))},null,8,["tooltip"]),l(s,{tooltip:e.__("Attach a file"),icon:de,onClick:a[7]||(a[7]=i=>W.value=!0)},null,8,["tooltip"]),l(s,{tooltip:e.__("Delete"),variant:"subtle",icon:"trash-2",theme:"red",onClick:te},null,8,["tooltip"])])])]),c.value.sla_status?(n(),f(Ke,{key:0,modelValue:c.value,"onUpdate:modelValue":a[8]||(a[8]=i=>c.value=i),onUpdateField:H},null,8,["modelValue"])):u("",!0),o(A).data?(n(),h("div",ja,[l(ca,{sections:o(A).data,addContact:G,doctype:"CRM Deal",docname:C.dealId,onReload:o(A).reload,onBeforeFieldChange:se,onAfterFieldChange:X},{actions:d(({section:i})=>[i.name=="contacts_section"?(n(),h("div",Wa,[l(_a,{value:"",doctype:"Contact",onChange:a[9]||(a[9]=v=>G(v)),onCreate:(v,S)=>{ae.value={first_name:v,company_name:c.value.organization},T.value=!0,S()}},{target:d(({togglePopover:v})=>[l(s,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:S=>v()},null,8,["onClick"])]),_:1},8,["onCreate"])])):u("",!0)]),default:d(({section:i})=>{var v,S,le,ne,re;return[i.name=="contacts_section"?(n(),h("div",Ga,[(v=o(_))!=null&&v.loading&&((le=(S=o(_))==null?void 0:S.data)==null?void 0:le.length)==0?(n(),h("div",Ha,[l(Qe,{class:"h-4 w-4"}),m("span",null,x(e.__("Loading...")),1)])):(re=(ne=o(_))==null?void 0:ne.data)!=null&&re.length?(n(!0),h(ye,{key:1},za(o(_).data,(b,ie)=>(n(),h("div",{key:b.name},[m("div",{class:K(["px-2 pb-2.5",[ie==0?"pt-5":"pt-2.5"]])},[l(ga,{opened:b.opened},{header:d(({opened:Pe,toggle:ce})=>[m("div",Xa,[m("div",{class:"flex h-7 items-center gap-2 truncate",onClick:ue=>ce()},[l(o(ke),{label:b.full_name,image:b.image,size:"md"},null,8,["label","image"]),m("div",Ja,x(b.full_name),1),b.is_primary?(n(),f(p,{key:0,class:"ml-2",variant:"outline",label:e.__("Primary"),theme:"green"},null,8,["label"])):u("",!0)],8,Ya),m("div",Ka,[l(o(_e),{options:Ee(b)},{default:d(()=>[l(s,{icon:"more-horizontal",class:"text-ink-gray-5",variant:"ghost"})]),_:2},1032,["options"]),l(s,{variant:"ghost",tooltip:e.__("View contact"),icon:ra,onClick:ue=>o(U).push({name:"Contact",params:{contactId:b.name}})},null,8,["tooltip","onClick"]),l(s,{variant:"ghost",class:K(["transition-all duration-300 ease-in-out",{"rotate-90":Pe}]),icon:"chevron-right",onClick:ue=>ce()},null,8,["class","onClick"])])])]),default:d(()=>[m("div",Qa,[m("div",Za,[l(me,{class:"h-4 w-4"}),Ce(" "+x(b.email),1)]),m("div",et,[l(Y,{class:"h-4 w-4"}),Ce(" "+x(b.mobile_no),1)])])]),_:2},1032,["opened"])],2),ie!=o(_).data.length-1?(n(),h("div",at)):u("",!0)]))),128)):(n(),h("div",tt,x(e.__("No contacts added")),1))])):u("",!0)]}),_:1},8,["sections","docname","onReload"])])):u("",!0)]}),_:1})])):V.value?(n(),f(Fe,{key:1,errorTitle:V.value,errorMessage:P.value},null,8,["errorTitle","errorMessage"])):u("",!0),$.value?(n(),f(ma,{key:2,modelValue:$.value,"onUpdate:modelValue":a[10]||(a[10]=t=>$.value=t),data:ee.value,options:{redirect:!1,afterInsert:t=>H("organization",t.name)}},null,8,["modelValue","data","options"])):u("",!0),T.value?(n(),f(fa,{key:3,modelValue:T.value,"onUpdate:modelValue":a[11]||(a[11]=t=>T.value=t),contact:ae.value,options:{redirect:!1,afterInsert:t=>G(t.name)}},null,8,["modelValue","contact","options"])):u("",!0),l(Xe,{modelValue:W.value,"onUpdate:modelValue":a[12]||(a[12]=t=>W.value=t),doctype:"CRM Deal",docname:C.dealId,onAfter:a[13]||(a[13]=()=>{var t,i;(i=(t=E.value)==null?void 0:t.all_activities)==null||i.reload(),e.changeTabTo("attachments")})},null,8,["modelValue","docname"]),M.value?(n(),f(qe,{key:4,modelValue:M.value,"onUpdate:modelValue":a[14]||(a[14]=t=>M.value=t),doctype:"CRM Deal",docname:C.dealId,name:"Deals"},null,8,["modelValue","docname"])):u("",!0),O.value?(n(),f(pa,{key:5,modelValue:O.value,"onUpdate:modelValue":a[15]||(a[15]=t=>O.value=t),deal:o(r)},null,8,["modelValue","deal"])):u("",!0)],64)}}};export{Jt as default};
//# sourceMappingURL=Deal-5e24d00b.js.map
